version: "3.9"

services:
  # === NCP GATEWAY ===
  ncp:
    image: node:20-slim
    container_name: mcp-ncp
    working_dir: /app
    command: [ "npx", "-y", "@portel/ncp" ]
    environment:
      NCP_CONFIG: /app/ncp.config.json
      # Pass through all secrets
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN}
      BRAVE_API_KEY: ${BRAVE_API_KEY}
      TODOIST_API_TOKEN: ${TODOIST_API_TOKEN}
      LINEAR_API_KEY: ${LINEAR_API_KEY}
      SNYK_TOKEN: ${SNYK_TOKEN}
      GITGUARDIAN_API_KEY: ${GITGUARDIAN_API_KEY}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
      MONGODB_URI: ${MONGODB_URI}
      DATABASE_URL: ${DATABASE_URL}
      PGHOST: ${PGHOST}
      PGUSER: ${PGUSER}
      PGPASSWORD: ${PGPASSWORD}
      PGDATABASE: ${PGDATABASE}
      # Framework Settings
      LSM_LANGUAGE: ${LSM_LANGUAGE}
      LSM_FRAMEWORK: ${LSM_FRAMEWORK}
      LSP_LANGUAGE: ${LSP_LANGUAGE}
      # Context & Search Settings
      SERENA_CONTEXT: ${SERENA_CONTEXT}
      SEARXNG_HOST: ${SEARXNG_HOST}
      SEARXNG_PORT: ${SEARXNG_PORT}
    volumes:
      - ./ncp.config.json:/app/ncp.config.json:ro
      - ./workspace:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped
    depends_on:
      - searxng

  # === CORE DEVELOPMENT ===
  filesystem:
    image: node:20-slim
    container_name: mcp-filesystem
    working_dir: /workspace
    command: [ "npx", "-y", "@modelcontextprotocol/server-filesystem", "D:/Coding" ]
    volumes:
      - D:/Coding:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  git:
    image: node:20-slim
    container_name: mcp-git
    working_dir: /workspace
    command: [ "npx", "-y", "@modelcontextprotocol/server-git" ]
    volumes:
      - D:/Coding:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  github:
    image: node:20-slim
    container_name: mcp-github
    command: [ "npx", "-y", "@modelcontextprotocol/server-github" ]
    environment:
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === CODE INTELLIGENCE (Languages & Frameworks) ===
  lsmcp:
    image: node:20-slim
    container_name: mcp-lsmcp
    working_dir: /workspace
    command: [ "npx", "-y", "@mizchi/lsmcp" ]
    volumes:
      - D:/Coding:/workspace
    environment:
      LSM_LANGUAGE: ${LSM_LANGUAGE}
      LSM_FRAMEWORK: ${LSM_FRAMEWORK}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Python Support (Replaces generic lsp)
  pylance:
    image: node:20-slim
    container_name: mcp-pylance
    working_dir: /workspace
    command: [ "npx", "-y", "pylance-mcp-server" ]
    volumes:
      - D:/Coding:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Rust Support
  rust-analyzer:
    image: node:20-slim
    container_name: mcp-rust
    working_dir: /workspace
    command: [ "npx", "-y", "@modelcontextprotocol/server-rust-analyzer" ]
    volumes:
      - D:/Coding:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # C/C++ Support
  clangd:
    image: node:20-slim
    container_name: mcp-clangd
    working_dir: /workspace
    command: [ "npx", "-y", "@modelcontextprotocol/server-clangd" ]
    volumes:
      - D:/Coding:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  serena:
    image: node:20-slim
    container_name: mcp-serena
    working_dir: /workspace
    command: [ "npx", "-y", "@oraios/serena", "--context", "ide-assistant" ]
    volumes:
      - D:/Coding:/workspace
    environment:
      SERENA_CONTEXT: ${SERENA_CONTEXT}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  context7:
    image: node:20-slim
    container_name: mcp-context7
    command: [ "npx", "-y", "@upstash/context7-mcp" ]
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === EXECUTION ===
  desktop-commander:
    image: node:20-slim
    container_name: mcp-commander
    working_dir: /workspace
    command: [ "npx", "-y", "@wonderwhy-er/ClaudeComputerCommander" ]
    volumes:
      - D:/Coding:/workspace
    environment:
      SHELL_TYPE: ${SHELL_TYPE}
      ALLOWED_COMMANDS: ${ALLOWED_COMMANDS}
      ALLOWED_PATHS: D:/Coding
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === REASONING, MEMORY & TASKS ===
  sequential-thinking:
    image: node:20-slim
    container_name: mcp-sequential
    command: [ "npx", "-y", "@modelcontextprotocol/server-sequential-thinking" ]
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  memory:
    image: node:20-slim
    container_name: mcp-memory
    command: [ "npx", "-y", "@modelcontextprotocol/server-memory" ]
    volumes:
      - mcp-memory-data:/data
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # SHRIMP TASK MANAGER (Restored)
  shrimp-task-manager:
    image: node:20-slim
    container_name: mcp-shrimp
    command: [ "npx", "-y", "mcp-shrimp-task-manager" ]
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === SEARCH ===
  searxng:
    image: searxng/searxng:latest
    container_name: searxng-instance
    ports:
      - "8080:8080"
    volumes:
      - searxng-data:/etc/searxng
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped
    environment:
      - SEARXNG_SECRET=${SEARXNG_SECRET:-thirdrailtoolsecret123}

  searxng-mcp:
    image: node:20-slim
    container_name: mcp-searxng
    working_dir: /app
    command: [ "node", "/app/searxng-mcp.js" ]
    volumes:
      - ./mcp-servers/searxng-mcp.js:/app/searxng-mcp.js
    environment:
      SEARXNG_HOST: ${SEARXNG_HOST}
      SEARXNG_PORT: ${SEARXNG_PORT}
    networks:
      - mcp-net
    depends_on:
      - searxng
    stdin_open: true
    tty: true
    restart: unless-stopped

  brave-search:
    image: node:20-slim
    container_name: mcp-brave
    command: [ "npx", "-y", "@modelcontextprotocol/server-brave-search" ]
    environment:
      BRAVE_API_KEY: ${BRAVE_API_KEY}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === DATABASES (SQL, NoSQL, Vector) ===
  # PostgreSQL (Self-Hosted)
  postgres:
    image: node:20-slim
    container_name: mcp-postgres
    command: [ "npx", "-y", "@modelcontextprotocol/server-postgres" ]
    environment:
      PGHOST: ${PGHOST}
      PGUSER: ${PGUSER}
      PGPASSWORD: ${PGPASSWORD}
      PGDATABASE: ${PGDATABASE}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # SQLite
  sqlite:
    image: node:20-slim
    container_name: mcp-sqlite
    working_dir: /workspace
    command: [ "npx", "-y", "@modelcontextprotocol/server-sqlite", "/workspace/data.db" ]
    volumes:
      - D:/Coding:/workspace
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Supabase
  supabase:
    image: node:20-slim
    container_name: mcp-supabase
    command: [ "npx", "-y", "@supabase/mcp-server" ]
    environment:
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Neon (Serverless Postgres)
  neon:
    image: node:20-slim
    container_name: mcp-neon
    command: [ "npx", "-y", "@neondatabase/mcp-server" ]
    environment:
      DATABASE_URL: ${DATABASE_URL}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # MongoDB (NoSQL)
  mongodb:
    image: node:20-slim
    container_name: mcp-mongodb
    command: [ "npx", "-y", "@mongodb/mcp-server" ]
    environment:
      MONGODB_URI: ${MONGODB_URI}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # Chroma (Vector DB)
  chroma:
    image: node:20-slim
    container_name: mcp-chroma
    command: [ "npx", "-y", "@chroma/mcp-server" ]
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === PROJECT MANAGEMENT ===
  todoist:
    image: node:20-slim
    container_name: mcp-todoist
    command: [ "npx", "-y", "@todoist/mcp-server" ]
    environment:
      TODOIST_API_TOKEN: ${TODOIST_API_TOKEN}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  linear:
    image: node:20-slim
    container_name: mcp-linear
    command: [ "npx", "-y", "@linear/mcp-server" ]
    environment:
      LINEAR_API_KEY: ${LINEAR_API_KEY}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === INFRASTRUCTURE & DEPLOYMENT ===
  docker:
    image: node:20-slim
    container_name: mcp-docker
    command: [ "npx", "-y", "@modelcontextprotocol/server-docker" ]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  kubernetes:
    image: node:20-slim
    container_name: mcp-k8s
    command: [ "npx", "-y", "@modelcontextprotocol/server-kubernetes" ]
    # Mount kubeconfig if needed
    # volumes:
    #   - ${USERPROFILE}/.kube/config:/root/.kube/config
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  cloudflare:
    image: node:20-slim
    container_name: mcp-cloudflare
    command: [ "npx", "-y", "@modelcontextprotocol/server-cloudflare" ]
    environment:
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === SECURITY & TESTING ===
  snyk:
    image: node:20-slim
    container_name: mcp-snyk
    command: [ "npx", "-y", "@snyk/mcp-server" ]
    environment:
      SNYK_TOKEN: ${SNYK_TOKEN}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  gitguardian:
    image: node:20-slim
    container_name: mcp-gitguardian
    command: [ "npx", "-y", "@gitguardian/mcp-server" ]
    environment:
      GITGUARDIAN_API_KEY: ${GITGUARDIAN_API_KEY}
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  playwright:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    container_name: mcp-playwright
    command: [ "npx", "-y", "@playwright/mcp" ]
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

  # === ORCHESTRATION ===
  compass:
    image: node:20-slim
    container_name: mcp-compass
    command: [ "npx", "-y", "@mcp-compass/server" ]
    networks:
      - mcp-net
    stdin_open: true
    tty: true
    restart: unless-stopped

networks:
  mcp-net:
    external: true

volumes:
  mcp-memory-data:
  searxng-data:

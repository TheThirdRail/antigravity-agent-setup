<?xml version="1.0" encoding="UTF-8"?>
<workflow name="archive" thinking="Normal">
  <metadata>
    <description>Archive Mode - Index the project to databases for AI context preservation</description>
  </metadata>

  <purpose>Archive the current project state to databases for persistent AI context.</purpose>

  <when_to_use>
    <trigger>After completing a major feature or milestone</trigger>
    <trigger>Before taking a break from the project</trigger>
    <trigger>To ensure AI has context in future sessions</trigger>
    <trigger>After significant refactoring</trigger>
  </when_to_use>

  <databases>
    <database name="mem0" alias="memory">
      <stores>Function signatures, file purposes, architectural decisions</stores>
    </database>
    <database name="codegraph">
      <stores>Code relationships, call graphs, dependencies</stores>
    </database>
    <database name="ragdocs">
      <stores>Documentation, comments, README content</stores>
    </database>
  </databases>

  <steps>
    <step number="1" name="Gather Project Information">
      <collect>All source file paths and their purposes</collect>
      <collect>Key function/class signatures</collect>
      <collect>Architectural decisions made</collect>
      <collect>Dependencies and their roles</collect>
      <collect>Important patterns used</collect>
    </step>

    <step number="2" name="Archive to mem0/memory">
      <store>Project name and purpose</store>
      <store>Tech stack used</store>
      <store>Key files and their roles</store>
      <store>Important functions with signatures</store>
      <store>Architectural patterns (e.g., "Uses MVC pattern")</store>
      <store>Non-obvious decisions and WHY they were made</store>
    </step>

    <step number="3" name="Archive to codegraph">
      <store>File dependency graph</store>
      <store>Function call relationships</store>
      <store>Class inheritance hierarchies</store>
      <store>Import/export maps</store>
      <store>Which files depend on which</store>
    </step>

    <step number="4" name="Archive to ragdocs">
      <store>README content</store>
      <store>Code comments</store>
      <store>Docstrings</store>
      <store>API documentation</store>
      <store>Setup instructions</store>
    </step>

    <step number="5" name="Verify Archive">
      <action>Query each database to confirm data was stored</action>
      <action>Test a sample retrieval</action>
      <action>Note any failures for retry</action>
    </step>
  </steps>

  <what_gets_archived>
    <category name="Structure">File tree, folder purposes</category>
    <category name="Functions">Name, params, return type, location, purpose</category>
    <category name="Classes">Name, methods, relationships</category>
    <category name="Decisions">Why X was chosen over Y</category>
    <category name="Patterns">Design patterns, conventions used</category>
    <category name="Dependencies">What external libs are used and why</category>
  </what_gets_archived>

  <exit_criteria>
    <criterion>All 3 databases updated</criterion>
    <criterion>Verification queries succeed</criterion>
    <criterion>Summary provided to user</criterion>
  </exit_criteria>
</workflow>
